---
title: "Web Data Collection with R"
author: "Peter Meißner / 2016-02-29 --  2016-03-04 / ECPR WSMT"
header-includes:
  - \definecolor{links}{HTML}{800080}
  - \hypersetup{colorlinks,linkcolor=,urlcolor=links}
output:
  beamer_presentation:
    fonttheme: structurebold
    keep_tex: yes
    toc: yes
  slidy_presentation: default
subtitle: Regular Expressions / RegEx
keep_tex: yes
---


# How Regular Expressions work ...

## What is it all about? 

1) Regular Expressions refer to combination of two things
    - a **syntax** that allows to define string patterns
        - e.g.: "`[pP]eter`", "`\\d{4}-\\d{1,2}-\\d{1,2}`"
    - a set of **functions** doing string handling 
        - base R has `grep()`, `grepl()`, `substring()`, ... nice because of options ignore.case and invert and bcause build in 
        - more convenient stringr/stringi functions: `str_detect()`, `str_replace()`, `str_extract()`, ... 
        


# Patterns 

## Patterns
2) [Regular Expressions providing string patterns](http://regexlib.com/CheatSheet.aspx)

    pattern               | description
    --------------------- | -----------------------------------
    **`"Hallo"`**         | 1:1 
    **`"."`**             | any character
    **`"[]"`**            | placeholder for one character
    **`"[abc]"`**         | set of characters (e.g. a,b, and c)
    **`"[a-z]"`**         | range of characters (e.g. a-z, not è, ä, ...)
    **`"a*"` /  `"a+"`**  | none or more /  one or more
    **`"a{2,4}"`**        | two up to four 
    **`"ac|b"`**          | ac or b
    **`"[^ab]"`**         | non of those
    **`"^a"`**            | starting with a
    **`"a$"`**            | ending with a


## Special Characters
3) [Expressing Patterns](http://regexlib.com/CheatSheet.aspx)

    pattern               | description
    --------------------- | -----------------------------------
    **`"\n"`**            | newline
    **`"\r"`**            | carriage return
    **`"\t"`**            | tab
    **`"\b"`**            | word boundary (between `"\\w"` and `"\\W"`)
    **`"\122"`**          | [matches ASCII character number 82 (octal)
    **`"\x52"`**          | matches ASCII character number 82 (hexadecimal)
    **`"\u0052"`**        | matches Unicode character number 82 (hexadecimal)


## Character Classes
3) [Expressing Character Classes](http://regexlib.com/CheatSheet.aspx)

pattern               | description
--------------------- | -----------------------------------
**`"\\d"` / `"\\D"`** | digit / no digit
**`"\\w"` / `"\\W"`** | word char. / no word char
**`"\\s"` / `"\\S"`** | white space char. / no ws char
**`"\\p{Currency_Symbol}"`** | [unicode groups and blocks](http://www.regular-expressions.info/unicode.html)
**`"[[:digit:]]"`**   | digit 
**`"[[:alpha:]]"`**   | characters (also è)
**`"[[:alphanum:]]"`**| word char.
**`"[^[:alphanum:]]"`** | white space char.


## Syntax Characters
4) some characters have special meaning and cannot be used literally

-  \  .   $     ^     {     [     (     |     )     ]     }     *     +     ? 
  

    character             | description    | matching
    --------------------- | -------------- | ---------
    **`"\"`** | escapes `"\"`, extra chars | `grep("\\\\","\\")`
    **`"{"`** | numeral classifier         | `grep("\\{","{")`
    ... | ... | ... 
    


# Functions
    
## functions for string detection

5) base functions for string detection / manipulation

    name     | description
    -------- | ------------
    `grep()`     | searches for pat. and returns numeric index/content
    `grepl()`    | searches for pat. and returns logical index
    `gregexpr()` | gives back each position of match    
    `nchar()`    | length of string
    `substr()`   | extracts sequence of characters
    `sub()`      | replace one pat. match in string with other string
    `gsub()`     | replace all pat. matches in string with other string
    `paste()`    | concatonates vector elements into one string
    `paste0()`   | concatonates vector elements into one string
    `-` | duplicates string
    `-` | removes leading /trailing whitespace
    `-` | adds whitespace to left, right, or both
    `-` | returns matrix of strings x matches + 1
    `cat()` | prints text to screen 

## functions for string detection

6) stringr/stringi functions for string detection / manipulation

    name     | description
    -------- | ------------
    `-`     | searches for pat. and ret. numeric index/cont.
    `str_detect()`    | searches for pat. and returns logical index
    `str_locate()` | gives back each position of match    
    `str_length()`    | length of str.
    `str_sub()`   | extracts sequence of characters
    `str_replace` | repl. one pat. match in str. with other str.
    `str_replace_all()`     | repl. all pat. matches in str. with other str.
    `-`    | concatonates vector elements into one str.
    `str_c()`   | concatonates vector elements into one str.
    `str_dup` | duplicates string
    `str_trim` | removes leading /trailing whitespace
    `str_pad` | adds whitespace to left, right, or both
    `str_match` | returns matrix of strings x matches + 1
    `cat()` | prints text to screen 



# Character Encodings

##Character Encodings

Character Encodings are ... 

- are like family ...
- ... some of them you do not like but cannot avoid ...
- ... something we will struggle with but have cope anyways

The best thing is ...

- R has them all 

The worst thing is ... 

- R has them all 

##Character Encodings
- computers store everything as 0s and 1s (bits)
- in cs there are differing layers of abstraction
- one bit of information is called bit
- bits are quite uninformative as they only ave two states
- so they are are grouped into bytes (8 bits)
- one byte can have 256 different values (2^8)
- so it can store numbers 0 to 255 or 1 to 256 or ... -127 to 128
- or it can map to characters e.g. ASCII (abcABC.:-_,;#'+*~|<>!"§$%&/()=?}][{\}^°, ...")
- ASCII is a character set - the set of characters you want to be able to store - even 7 Bits would suffice to store it

##Character Encodings
- for larger character sets than ASCII (ä ö ü é è ... ) on needs to get clever since one byte does not suffice to map all characters to 0s and 1s
- unfortunate people got clever in differing ways 
    1) using more than one byte to map more characters ('wide' characters, UTF-16, USC-2, Windows OSs)
    2) using one or more bytes and using the first byte to encode how manies are used ('multi-byte characters', UTF-8, Unix based OSs)
- otherwise we would not have to talk about character sets and character encodings
    

##Character Encodings
```{r}
rawToBits(as.raw(62:66)) # as bits
as.raw(62:66) # bytes as hexa-decimal
as.numeric(as.raw(62:66)) # as numbers
rawToChar(as.raw(62:66)) # bytes as chararcters
```


##A character set problem
```{r}
text           <- rawToChar(as.raw(228))
Encoding(text) <- "UTF-8" 
text
Encoding(text) <- "latin1" 
text
```

Results differ because for latin1 character 228 is know but not for UTF-8

##An encoding problem
Of cause UTF-8 knows how to encode "ä" ... 
```{r}
text <- "ä"
charToRaw(text)
Encoding(text) <- "latin1"
text
```
... but here the results differ because "UTF-8" has another system translating characters to bytes. In latin1 the two bytes are interpreted as two characters. 



##Which default encoding does your R use
```{r}
Sys.getlocale()

# if yor locale is something other than UTF-8, 
# switch 'latin1' and 'UTF-8' and you shall be good to go
```

##Changing interpretation of bytes
```{r}
text <- "Små grodorna, små grodorna är lustiga att se."
Encoding(text) <- "UTF-8"
text
```

##Changing interpretation of bytes
```{r}
text <- "Små grodorna, små grodorna är lustiga att se."
Encoding(text) <- "latin1"
text
```

##Changing bytes and interpretation
```{r}
text <- "Små grodorna, små grodorna är lustiga att se."
text <- iconv(text, "UTF-8", "latin1")
Encoding(text)
text
```

##Noe that all sources might have another encoding than your R default locale!
```{r}
text <- "Små grodorna, små grodorna är lustiga att se."
text <- iconv(text, "UTF-8", "latin1")
writeLines(text, "text_latin1.txt", useBytes = TRUE)
text <- readLines("text_latin1.txt")
Encoding(text)
text
Encoding(text) <- "latin1"
text
```


# URL character encoding

##URL character encoding

- URLs have to wok for differing systems and OSs
- therefore URLs have their own system of ensuring consistency
- URL-encodings





















